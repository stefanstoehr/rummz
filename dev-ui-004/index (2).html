<!DOCTYPE html>
<head>
  <meta charset="UTF-8">
  <link rel="icon" href="data:,">
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
</head>
<body>
  <div class="layout">
    <header>Header</header>
    <main>
      <button id="scroll-left" aria-label="Nach links scrollen">&lt;</button>
      <div class="grid-content">
        </div>
      <button id="scroll-right" aria-label="Nach rechts scrollen">&gt;</button>
    </main>
    <footer>Footer</footer>
  </div>
  <script>
// 1. DATA MODEL (Single Source of Truth)
let cardsData = [];
let mapInstances = {}; // To hold Leaflet map instances

function createNewLayer(cardId, layerNum) {
    return {
        id: `${cardId}-layer-${layerNum}-${Date.now()}`,
        name: '',
        depth: null
    };
}

function createNewCard(index, initialView = null) {
    const cardId = `card-${Date.now()}-${index}`;
    return {
        id: cardId,
        coords: null,
        nhn: null,
        layers: [createNewLayer(cardId, 1)],
        initialView: initialView
    };
}


// 2. RENDER FUNCTIONS
const gridContent = document.querySelector('.grid-content');

function renderLayers(card, container) {
    container.innerHTML = ''; // Clear existing layers
    card.layers.forEach((layer, layerIndex) => {
        const layerDiv = document.createElement('div');
        layerDiv.className = 'card-layer';
        layerDiv.id = layer.id;
        layerDiv.innerHTML = `
            <div class="layer-header">
                 <button class="delete-layer-btn ${card.layers.length <= 1 ? 'invisible' : ''}" aria-label="Layer löschen" data-card-id="${card.id}" data-layer-id="${layer.id}">-</button>
                <strong>Layer ${layerIndex + 1}</strong>
            </div>
            <label for="layername-${layer.id}">Schichtname: </label>
            <input type="text" id="layername-${layer.id}" name="layername" placeholder="Name"
                   data-card-id="${card.id}" data-layer-id="${layer.id}" value="${layer.name || ''}"><br>
            <label for="layertiefe-${layer.id}">Tiefe (m): </label>
            <input type="number" id="layertiefe-${layer.id}" name="layertiefe" min="0" step="0.01" placeholder="Tiefe"
                   data-card-id="${card.id}" data-layer-id="${layer.id}" value="${layer.depth || ''}"><br>
            <button class="add-layer-btn" aria-label="Layer hinzufügen" data-card-id="${card.id}" data-layer-index="${layerIndex}">+</button>
        `;
        container.appendChild(layerDiv);
    });
}

function createCardElement(card, index) {
    const cardElem = document.createElement('div');
    cardElem.className = 'card base-card';
    cardElem.id = card.id;

    const header = document.createElement('div');
    header.className = 'card-header';
    header.innerHTML = `
        <button class="delete-card-btn" aria-label="Card löschen" data-card-id="${card.id}">-</button>
        <div class="card-title">Drill Core ${index + 1}</div>
    `;
    cardElem.appendChild(header);

    const mapDiv = document.createElement('div');
    mapDiv.className = 'card-map';
    mapDiv.id = `map-${card.id}`;
    mapDiv.style.height = '200px';
    mapDiv.style.marginBottom = '1rem';
    cardElem.appendChild(mapDiv);

    const coordsDiv = document.createElement('div');
    coordsDiv.className = 'card-coords';
    cardElem.appendChild(coordsDiv);
    updateCoordsDisplay(coordsDiv, card.coords);

    const nhnDiv = document.createElement('div');
    nhnDiv.className = 'card-nhn';
    nhnDiv.innerHTML = `
        <label for="nhn-${card.id}">NHN (m): </label>
        <input type="number" id="nhn-${card.id}" name="nhn" min="0" step="0.01" placeholder="optional"
               data-card-id="${card.id}" value="${card.nhn || ''}">
    `;
    cardElem.appendChild(nhnDiv);

    const layersContainer = document.createElement('div');
    layersContainer.className = 'layers-container';
    cardElem.appendChild(layersContainer);
    renderLayers(card, layersContainer);

    return cardElem;
}

function createAddBtn(index) {
    const addBtn = document.createElement('button');
    addBtn.className = 'add-card-btn';
    addBtn.setAttribute('aria-label', 'Card hinzufügen');
    addBtn.textContent = '+';
    addBtn.dataset.index = index;
    return addBtn;
}

function render() {
    gridContent.innerHTML = '';

    const infoDiv = document.createElement('div');
    infoDiv.className = 'info base-card';
    gridContent.appendChild(infoDiv);

    cardsData.forEach((card, index) => {
        gridContent.appendChild(createAddBtn(index));
        gridContent.appendChild(createCardElement(card, index));
    });

    gridContent.appendChild(createAddBtn(cardsData.length));

    const previewDiv = document.createElement('div');
    previewDiv.className = 'preview base-card';
    gridContent.appendChild(previewDiv);

    cardsData.forEach(initLeafletMap);
    updateUICardControls();
}

function updateUICardControls() {
    const cards = gridContent.querySelectorAll('.card');
    const addBtns = gridContent.querySelectorAll('.add-card-btn');
    const isSingleCard = cardsData.length <= 1;

    cards.forEach((cardElem, index) => {
        const title = cardElem.querySelector('.card-title');
        if (title) {
            title.textContent = `Drill Core ${index + 1}`;
        }
        const deleteBtn = cardElem.querySelector('.delete-card-btn');
        if (deleteBtn) {
            deleteBtn.classList.toggle('invisible', isSingleCard);
        }
    });

    addBtns.forEach((btn, index) => {
        btn.dataset.index = index;
    });
}


// 3. EVENT DELEGATION & HANDLERS
gridContent.addEventListener('click', function(event) {
    const target = event.target;
    if (target.classList.contains('invisible')) {
        return;
    }

    if (target.matches('.add-card-btn')) {
        const index = parseInt(target.dataset.index, 10);
        let initialView = null;

        if (index > 0) {
            const prevCard = cardsData[index - 1];
            const prevMap = mapInstances[prevCard.id];
            if (prevMap) {
                initialView = {
                    center: prevMap.getCenter(),
                    zoom: prevMap.getZoom()
                };
            }
        }

        const newCard = createNewCard(index, initialView);
        cardsData.splice(index, 0, newCard);

        const newCardElem = createCardElement(newCard, index);
        const newAddBtn = createAddBtn(index);
        
        gridContent.insertBefore(newAddBtn, target);
        gridContent.insertBefore(newCardElem, target);

        initLeafletMap(newCard);
        updateUICardControls();
    }

    if (target.matches('.delete-card-btn')) {
        const cardId = target.dataset.cardId;
        const cardIndex = cardsData.findIndex(c => c.id === cardId);

        if (cardIndex > -1) {
            if (mapInstances[cardId]) {
                mapInstances[cardId].remove();
                delete mapInstances[cardId];
            }

            cardsData.splice(cardIndex, 1);

            const cardElem = document.getElementById(cardId);
            if (cardElem) {
                const precedingAddBtn = cardElem.previousElementSibling;
                if(precedingAddBtn && precedingAddBtn.classList.contains('add-card-btn')){
                    gridContent.removeChild(precedingAddBtn);
                }
                gridContent.removeChild(cardElem);
            }

            updateUICardControls();
        }
    }

    if (target.matches('.add-layer-btn')) {
        const cardId = target.dataset.cardId;
        const layerIndex = parseInt(target.dataset.layerIndex, 10);
        const card = cardsData.find(c => c.id === cardId);
        if (card) {
            const newLayer = createNewLayer(card.id, card.layers.length + 1);
            card.layers.splice(layerIndex + 1, 0, newLayer);
            
            const cardElem = document.getElementById(cardId);
            const layersContainer = cardElem.querySelector('.layers-container');
            renderLayers(card, layersContainer);
        }
    }

    if (target.matches('.delete-layer-btn')) {
        const cardId = target.dataset.cardId;
        const layerId = target.dataset.layerId;
        const card = cardsData.find(c => c.id === cardId);
        if (card && card.layers.length > 1) {
            card.layers = card.layers.filter(layer => layer.id !== layerId);

            const cardElem = document.getElementById(cardId);
            const layersContainer = cardElem.querySelector('.layers-container');
            renderLayers(card, layersContainer);
        }
    }
});

gridContent.addEventListener('input', function(event) {
    const target = event.target;
    const cardId = target.dataset.cardId;
    const layerId = target.dataset.layerId;

    const card = cardsData.find(c => c.id === cardId);
    if (!card) return;

    if (target.name === 'nhn') {
        card.nhn = target.value ? parseFloat(target.value) : null;
    }

    const layer = card.layers.find(l => l.id === layerId);
    if (!layer) return;

    if (target.name === 'layername') {
        layer.name = target.value;
    } else if (target.name === 'layertiefe') {
        layer.depth = target.value ? parseFloat(target.value) : null;
    }
});


// 4. LEAFLET & INITIALIZATION
function updateCoordsDisplay(element, coords) {
    if (element) {
        element.textContent = coords ?
            `Koordinaten: ${coords.lat.toFixed(5)}, ${coords.lng.toFixed(5)}` :
            'Koordinaten: -';
    }
}

function initLeafletMap(card) {
    const mapId = `map-${card.id}`;
    const mapElement = document.getElementById(mapId);
    if (!mapElement || mapElement._leaflet_id) {
        return;
    }

    let initialCenter = [51.505, 7.505];
    let initialZoom = 5;

    if (card.initialView) {
        initialCenter = card.initialView.center;
        initialZoom = card.initialView.zoom;
    }

    const map = L.map(mapId).setView(initialCenter, initialZoom);
    mapInstances[card.id] = map;

    L.tileLayer.wms('https://ows.terrestris.de/osm/service?', {
        layers: 'OSM-WMS',
        format: 'image/png',
        transparent: true,
        attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    let marker;

    if (card.coords) {
        marker = L.marker(card.coords, { draggable: true }).addTo(map);
        map.setView(card.coords, 13);
        const coordsDiv = mapElement.parentElement.querySelector('.card-coords');
        updateCoordsDisplay(coordsDiv, card.coords);
    }

    const onMarkerMove = (e) => {
        const newCoords = e.target.getLatLng();
        card.coords = newCoords;
        const coordsDiv = mapElement.parentElement.querySelector('.card-coords');
        updateCoordsDisplay(coordsDiv, newCoords);
    };

    if (marker) {
        marker.on('move', onMarkerMove);
    }

    map.on('click', function(e) {
        card.coords = e.latlng;
        if (!marker) {
            marker = L.marker(e.latlng, { draggable: true }).addTo(map);
            marker.on('move', onMarkerMove);
        } else {
            marker.setLatLng(e.latlng);
        }
        const coordsDiv = mapElement.parentElement.querySelector('.card-coords');
        updateCoordsDisplay(coordsDiv, e.latlng);
    });
}


// 5. INITIAL SETUP
document.getElementById('scroll-left').onclick = () => {
    gridContent.scrollBy({ left: -300, behavior: 'smooth' });
};
document.getElementById('scroll-right').onclick = () => {
    gridContent.scrollBy({ left: 300, behavior: 'smooth' });
};

cardsData.push(createNewCard(0));
render();
  </script>
</body>