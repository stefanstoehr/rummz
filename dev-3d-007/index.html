<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>3D-Baugrundmodell</title>
  <style>
    body {
      margin: 0;
      overflow: hidden;
    }
    canvas {
      display: block;
    }
  </style>
</head>
<body>
  <canvas id="bg"></canvas>
<script type="importmap">
{
  "imports": {
    "three": "https://cdn.jsdelivr.net/npm/three@0.165.0/build/three.module.js",
    "three/examples/jsm/": "https://cdn.jsdelivr.net/npm/three@0.165.0/examples/jsm/",
    "d3-delaunay": "https://cdn.jsdelivr.net/npm/d3-delaunay@6.0.2/+esm"
  }
}
</script>

<script type="module">
import * as THREE from 'three';
import { OrbitControls } from 'https://cdn.jsdelivr.net/npm/three@0.155.0/examples/jsm/controls/OrbitControls.js';
import { Delaunay } from 'd3-delaunay';

const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 10000);
const renderer = new THREE.WebGLRenderer({ canvas: document.getElementById('bg') });
renderer.setSize(window.innerWidth, window.innerHeight);
camera.position.set(0, 100, 800);

const controls = new OrbitControls(camera, renderer.domElement); // ✅ korrekt

// Licht
scene.add(new THREE.AmbientLight(0xffffff, 0.6));
const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
dirLight.position.set(100, 200, 100);
scene.add(dirLight);

// Beispiel-Bohrkerndaten
const boreholes = [
    {
        "id": "card-1758802902845-0",
        "title": "",
        "coords": {
            "lat": 51.76659143022729,
            "lng": 14.320914745330812
        },
        "nhn": 60,
        "layers": [
            {
                "id": "card-1758802902845-0-layer-1-1758802902845",
                "name": "Erde",
                "height": 50,
                "color": "#b35000"
            },
            {
                "id": "card-1758802902845-0-layer-2-1758802975698",
                "name": "Kies",
                "height": 100,
                "color": "#ffff00"
            }
        ],
        "initialView": null
    },
    {
        "id": "card-1758803010058-1",
        "title": "",
        "coords": {
            "lat": 51.76745458523478,
            "lng": 14.321129322052004
        },
        "nhn": 70,
        "layers": [
            {
                "id": "card-1758803010058-1-layer-1-1758803010058",
                "name": "Erde",
                "height": 70,
                "color": "#ae4a10"
            },
            {
                "id": "card-1758803010058-1-layer-2-1758803067602",
                "name": "Wasser",
                "height": 20,
                "color": "#0080ff"
            }
        ],
        "initialView": {
            "center": {
                "lat": 51.76705641554046,
                "lng": 14.320753812789919
            },
            "zoom": 16
        }
    },
    {
        "id": "card-1758803086715-2",
        "title": "",
        "coords": {
            "lat": 51.76754753940501,
            "lng": 14.320163726806642
        },
        "nhn": 50,
        "layers": [
            {
                "id": "card-1758803086715-2-layer-1-1758803086715",
                "name": "Sand",
                "height": 55,
                "color": "#ff3300"
            },
            {
                "id": "card-1758803086715-2-layer-2-1758803123531",
                "name": "Erde",
                "height": 80,
                "color": "#a94319"
            }
        ],
        "initialView": {
            "center": {
                "lat": 51.76705641554046,
                "lng": 14.320753812789919
            },
            "zoom": 16
        }
    },
    {
        "id": "card-1758803152467-3",
        "title": "",
        "coords": {
            "lat": 51.7664320767288,
            "lng": 14.320228099823
        },
        "nhn": 80,
        "layers": [
            {
                "id": "card-1758803152467-3-layer-1-1758803152467",
                "name": "Beton",
                "height": 20,
                "color": "#787878"
            },
            {
                "id": "card-1758803152467-3-layer-2-1758803181499",
                "name": "Kies",
                "height": 90,
                "color": "#fefd35"
            }
        ],
        "initialView": {
            "center": {
                "lat": 51.76705641554046,
                "lng": 14.320753812789919
            },
            "zoom": 16
        }
    }
]

// reference point = centroid -> equirectangular approximation
const refLat = boreholes.reduce((s,b)=>s+b.coords.lat,0)/boreholes.length;
const refLon = boreholes.reduce((s,b)=>s+b.coords.lng,0)/boreholes.length;
const metersPerDegLat = 111320;
const metersPerDegLon = 111320 * Math.cos(refLat * Math.PI/180);

function latLonToXZ(lat, lon) {
  const x = (lon - refLon) * metersPerDegLon;
  const z = (lat - refLat) * metersPerDegLat;
  return { x, z };
}

// Voronoi vorbereiten
const points = boreholes.map(b => {
  const { x, z } = latLonToXZ(b.coords.lat, b.coords.lng);
  return [x, z];
});
const delaunay = Delaunay.from(points); // ✅ korrekt
const voronoi = delaunay.voronoi([-500, -500, 500, 500]);

// Hilfsfunktion für Pause
function sleep(ms) {
  return new Promise(resolve => setTimeout(resolve, ms));
}

// Modell schrittweise erzeugen
async function buildModel() {
  for (let i = 0; i < boreholes.length; i++) {
    const borehole = boreholes[i];
    const cell = voronoi.cellPolygon(i);
    if (!cell) continue;

    let yOffset = borehole.nhn;

    for (let layer of borehole.layers) {
      const shape = new THREE.Shape();
      cell.forEach(([cx, cz], idx) => {
        if (idx === 0) shape.moveTo(cx, cz);
        else shape.lineTo(cx, cz);
      });

      const geometry = new THREE.ExtrudeGeometry(shape, {
        depth: layer.height,
        bevelEnabled: false
      });

      const material = new THREE.MeshStandardMaterial({ color: layer.color });
      const mesh = new THREE.Mesh(geometry, material);
      mesh.rotateX(-Math.PI / 2);
      mesh.position.set(0, yOffset - layer.height, 0);
      scene.add(mesh);

      yOffset -= layer.height;

      await sleep(50); // 0.05 Sekunden warten, bevor die nächste Schicht kommt
    }
  }
}

buildModel();

window.addEventListener('resize', onWindowResize,false);
function onWindowResize(){
  camera.aspect = window.innerWidth/window.innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(window.innerWidth, window.innerHeight);
}

function animate() {
  requestAnimationFrame(animate);
  controls.update();
  renderer.render(scene, camera);
}

animate();

</script>
</body>
</html>