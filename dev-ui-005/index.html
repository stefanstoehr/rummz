<!DOCTYPE html>
<head>
  <meta charset="UTF-8">
  <link rel="icon" href="data:,">
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
</head>
<body>
  <div class="layout">
    <header>Header</header>
    <main>
      <button id="scroll-left" aria-label="Nach links scrollen">&lt;</button>
      <div class="grid-content">
        </div>
      <button id="scroll-right" aria-label="Nach rechts scrollen">&gt;</button>
    </main>
    <footer>Footer</footer>
  </div>
  <script>
// 1. DATA MODEL (Single Source of Truth)
let cardsData = [];

// Function to create a new layer object
function createNewLayer(cardId, layerNum) {
    return {
        id: `${cardId}-layer-${layerNum}-${Date.now()}`,
        name: '',
        depth: null
    };
}

// Function to create a new card object
function createNewCard(index) {
    const cardId = `card-${Date.now()}-${index}`;
    return {
        id: cardId,
        coords: null,
        nhn: null,
        layers: [createNewLayer(cardId, 1)]
    };
}


// 2. RENDER FUNCTION
const gridContent = document.querySelector('.grid-content');

function render() {
    // Clear existing content
    gridContent.innerHTML = '';

    // Render info and preview divs
    const infoDiv = document.createElement('div');
    infoDiv.className = 'info base-card';
    gridContent.appendChild(infoDiv);

    // Render cards from data model
    cardsData.forEach((card, index) => {
        // Render add button before the card
        const addBtn = document.createElement('button');
        addBtn.className = 'add-card-btn';
        addBtn.setAttribute('aria-label', 'Card hinzufügen');
        addBtn.textContent = '+';
        addBtn.dataset.index = index; // Store index for event handling
        gridContent.appendChild(addBtn);

        // Create card element
        const cardElem = document.createElement('div');
        cardElem.className = 'card base-card';
        cardElem.id = card.id;

        // Card Header - CORRECTED
        const header = document.createElement('div');
        header.className = 'card-header';
        header.innerHTML = `
            <button class="delete-card-btn ${cardsData.length <= 1 ? 'invisible' : ''}" aria-label="Card löschen" data-card-id="${card.id}">-</button>
            <div class="card-title">Drill Core ${index + 1}</div>
        `;
        cardElem.appendChild(header);

        // Map
        const mapDiv = document.createElement('div');
        mapDiv.className = 'card-map';
        mapDiv.id = `map-${card.id}`;
        mapDiv.style.height = '200px';
        mapDiv.style.marginBottom = '1rem';
        cardElem.appendChild(mapDiv);

        // Coords
        const coordsDiv = document.createElement('div');
        coordsDiv.className = 'card-coords';
        coordsDiv.textContent = card.coords ?
            `Koordinaten: ${card.coords.lat.toFixed(5)}, ${card.coords.lng.toFixed(5)}` :
            'Koordinaten: -';
        cardElem.appendChild(coordsDiv);


        // NHN
        const nhnDiv = document.createElement('div');
        nhnDiv.className = 'card-nhn';
        nhnDiv.innerHTML = `
            <label for="nhn-${card.id}">NHN (m): </label>
            <input type="number" id="nhn-${card.id}" name="nhn" min="0" step="0.01" placeholder="optional"
                   data-card-id="${card.id}" value="${card.nhn || ''}">
        `;
        cardElem.appendChild(nhnDiv);


        // Layers - CORRECTED
        card.layers.forEach((layer, layerIndex) => {
            const layerDiv = document.createElement('div');
            layerDiv.className = 'card-layer';
            layerDiv.id = layer.id;
            layerDiv.innerHTML = `
                <div class="layer-header">
                     <button class="delete-layer-btn ${card.layers.length <= 1 ? 'invisible' : ''}" aria-label="Layer löschen" data-card-id="${card.id}" data-layer-id="${layer.id}">-</button>
                    <strong>Layer ${layerIndex + 1}</strong>
                </div>
                <label for="layername-${layer.id}">Schichtname: </label>
                <input type="text" id="layername-${layer.id}" name="layername" placeholder="Name"
                       data-card-id="${card.id}" data-layer-id="${layer.id}" value="${layer.name || ''}"><br>
                <label for="layertiefe-${layer.id}">Tiefe (m): </label>
                <input type="number" id="layertiefe-${layer.id}" name="layertiefe" min="0" step="0.01" placeholder="Tiefe"
                       data-card-id="${card.id}" data-layer-id="${layer.id}" value="${layer.depth || ''}"><br>
                <button class="add-layer-btn" aria-label="Layer hinzufügen" data-card-id="${card.id}" data-layer-index="${layerIndex}">+</button>
            `;
            cardElem.appendChild(layerDiv);
        });


        gridContent.appendChild(cardElem);
    });

    // Add final add button
    const finalAddBtn = document.createElement('button');
    finalAddBtn.className = 'add-card-btn';
    finalAddBtn.setAttribute('aria-label', 'Card hinzufügen');
    finalAddBtn.textContent = '+';
    finalAddBtn.dataset.index = cardsData.length;
    gridContent.appendChild(finalAddBtn);


    const previewDiv = document.createElement('div');
    previewDiv.className = 'preview base-card';
    gridContent.appendChild(previewDiv);

    // Initialize Leaflet maps
    cardsData.forEach(card => {
        initLeafletMap(card);
    });
}


// 3. EVENT DELEGATION & HANDLERS
gridContent.addEventListener('click', function(event) {
    const target = event.target;
    if (target.classList.contains('invisible')) {
        return; // Do nothing if the button is invisible
    }

    // Add Card
    if (target.matches('.add-card-btn')) {
        const index = parseInt(target.dataset.index, 10);
        const newCard = createNewCard(index);
        cardsData.splice(index, 0, newCard);
        render();
    }

    // Delete Card
    if (target.matches('.delete-card-btn')) {
        const cardId = target.dataset.cardId;
        cardsData = cardsData.filter(card => card.id !== cardId);
        render();
    }

    // Add Layer
    if (target.matches('.add-layer-btn')) {
        const cardId = target.dataset.cardId;
        const layerIndex = parseInt(target.dataset.layerIndex, 10);
        const card = cardsData.find(c => c.id === cardId);
        if (card) {
            const newLayer = createNewLayer(card.id, card.layers.length + 1);
            card.layers.splice(layerIndex + 1, 0, newLayer);
            render();
        }
    }

    // Delete Layer
    if (target.matches('.delete-layer-btn')) {
        const cardId = target.dataset.cardId;
        const layerId = target.dataset.layerId;
        const card = cardsData.find(c => c.id === cardId);
        if (card && card.layers.length > 1) {
            card.layers = card.layers.filter(layer => layer.id !== layerId);
            render();
        }
    }
});

gridContent.addEventListener('input', function(event) {
    const target = event.target;
    const cardId = target.dataset.cardId;
    const layerId = target.dataset.layerId;

    const card = cardsData.find(c => c.id === cardId);
    if (!card) return;

    if (target.name === 'nhn') {
        card.nhn = target.value ? parseFloat(target.value) : null;
    }

    const layer = card.layers.find(l => l.id === layerId);
    if (!layer) return;

    if (target.name === 'layername') {
        layer.name = target.value;
    } else if (target.name === 'layertiefe') {
        layer.depth = target.value ? parseFloat(target.value) : null;
    }
});


// 4. LEAFLET & INITIALIZATION
function initLeafletMap(card) {
    const mapId = `map-${card.id}`;
    const mapElement = document.getElementById(mapId);
    // Prevent re-initialization
    if (!mapElement || mapElement._leaflet_id) {
        return;
    }

    const map = L.map(mapId).setView([51.505, 7.505], 5);

    L.tileLayer.wms('https://ows.terrestris.de/osm/service?', {
        layers: 'OSM-WMS',
        format: 'image/png',
        transparent: true,
        attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    let marker;

    // Function to update coordinates in the DOM without a full re-render
    const updateCoordsDisplay = (latlng) => {
        const coordsDiv = mapElement.parentElement.querySelector('.card-coords');
        if (coordsDiv) {
            coordsDiv.textContent = `Koordinaten: ${latlng.lat.toFixed(5)}, ${latlng.lng.toFixed(5)}`;
        }
    };


    if (card.coords) {
        marker = L.marker(card.coords, {
            draggable: true
        }).addTo(map);
        map.setView(card.coords, 13);
    }

    // Event handler for marker movement
    const onMarkerMove = (e) => {
        card.coords = e.target.getLatLng();
        updateCoordsDisplay(card.coords);
    };


    if (marker) {
        marker.on('move', onMarkerMove);
    }

    map.on('click', function(e) {
        card.coords = e.latlng;
        if (!marker) {
            marker = L.marker(e.latlng, {
                draggable: true
            }).addTo(map);
            marker.on('move', onMarkerMove);
        } else {
            marker.setLatLng(e.latlng);
        }
        updateCoordsDisplay(card.coords);
    });
}


// Initial Setup
document.getElementById('scroll-left').onclick = () => {
    gridContent.scrollBy({
        left: -300,
        behavior: 'smooth'
    });
};
document.getElementById('scroll-right').onclick = () => {
    gridContent.scrollBy({
        left: 300,
        behavior: 'smooth'
    });
};

// Initial data load and render
cardsData.push(createNewCard(0));
render();
  </script>
</body>