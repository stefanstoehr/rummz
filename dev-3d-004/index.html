<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>3D Bohrkern Schichten - Demo</title>
<style>
  html,body{height:100%;margin:0}
  body{font-family:Arial,Helvetica,sans-serif;overflow:hidden}
  #info{position:absolute;left:10px;top:10px;background:rgba(255,255,255,0.85);padding:8px;border-radius:4px;z-index:2}
</style>
</head>
<body>
<!--<div id="info">Demo: mehrere Bohrungen (EPSG:4326 → lokale Meter). Klick auf eine Schicht zeigt Mächtigkeit.</div>-->

<script type="importmap">
{
  "imports": {
    "three": "https://cdn.jsdelivr.net/npm/three@0.165.0/build/three.module.js",
    "three/examples/jsm/": "https://cdn.jsdelivr.net/npm/three@0.165.0/examples/jsm/"
  }
}
</script>

<script type="module">
import * as THREE from 'three';
import { OrbitControls } from 'three/examples/jsm/controls/OrbitControls.js';

// Scene + renderer
const scene = new THREE.Scene();
scene.background = new THREE.Color(0xeaf0f6);

const renderer = new THREE.WebGLRenderer({antialias:true});
renderer.setPixelRatio(window.devicePixelRatio);
renderer.setSize(window.innerWidth, window.innerHeight);
document.body.appendChild(renderer.domElement);

// Camera
const camera = new THREE.PerspectiveCamera(50, window.innerWidth/window.innerHeight, 0.1, 5000);
camera.position.set(200, 200, 200);

// Lights
const dir = new THREE.DirectionalLight(0xffffff, 0.9);
dir.position.set(200,300,100);
scene.add(dir);
scene.add(new THREE.AmbientLight(0xffffff,0.4));

// Example borehole data in EPSG:4326 (lat, lon). elevation optional (m)
// Beispiel-Bohrkerndaten
const boreholes = [
    {
        "id": "card-1759150384263-0",
        "title": "RKS1",
        "coords": {
            "lat": 51.76749861403783,
            "lng": 14.321360745065757
        },
        "nhn": 63.5,
        "layers": [
            {
                "id": "card-1759150384263-0-layer-1-1759150384263",
                "name": "Erde",
                "height": 80,
                "color": "#c69262"
            },
            {
                "id": "card-1759150384263-0-layer-2-1759150556849",
                "name": "Sand",
                "height": 50,
                "color": "#fff700"
            },
            {
                "id": "card-1759150384263-0-layer-3-1759150585915",
                "name": "Wasser",
                "height": 70,
                "color": "#0080ff"
            }
        ],
        "initialView": null
    },
    {
        "id": "card-1759150643288-1",
        "title": "RKS2",
        "coords": {
            "lat": 51.767033840768775,
            "lng": 14.32125966599984
        },
        "nhn": 63.2,
        "layers": [
            {
                "id": "card-1759150643288-1-layer-1-1759150643288",
                "name": "Erde",
                "height": 15,
                "color": "#c69262"
            },
            {
                "id": "card-1759150643288-1-layer-2-1759150664020",
                "name": "Kies",
                "height": 56,
                "color": "#ff7b00"
            },
            {
                "id": "card-1759150643288-1-layer-3-1759150670051",
                "name": "Sand",
                "height": 54,
                "color": "#fff700"
            },
            {
                "id": "card-1759150643288-1-layer-4-1759150674425",
                "name": "Wasser",
                "height": 20,
                "color": "#0080ff"
            }
        ],
        "initialView": {
            "center": {
                "lat": 51.766983379342484,
                "lng": 14.320456784723097
            },
            "zoom": 17
        }
    },
    {
        "id": "card-1759150758907-2",
        "title": "RKS3",
        "coords": {
            "lat": 51.76652258464567,
            "lng": 14.321107216439064
        },
        "nhn": 64,
        "layers": [
            {
                "id": "card-1759150758907-2-layer-1-1759150758907",
                "name": "Asphalt",
                "height": 20,
                "color": "#808080"
            },
            {
                "id": "card-1759150758907-2-layer-2-1759150788608",
                "name": "Kies",
                "height": 50,
                "color": "#ff7b00"
            },
            {
                "id": "card-1759150758907-2-layer-3-1759150807930",
                "name": "Wasser",
                "height": 89,
                "color": "#0080ff"
            }
        ],
        "initialView": {
            "center": {
                "lat": 51.766983379342484,
                "lng": 14.32045876979828
            },
            "zoom": 17
        }
    },
    {
        "id": "card-1759150835357-3",
        "title": "RKS4",
        "coords": {
            "lat": 51.76647610652919,
            "lng": 14.320196814341875
        },
        "nhn": 62.87,
        "layers": [
            {
                "id": "card-1759150835357-3-layer-1-1759150835357",
                "name": "Erde",
                "height": 43,
                "color": "#c69262"
            },
            {
                "id": "card-1759150835357-3-layer-2-1759150875407",
                "name": "Kies",
                "height": 50,
                "color": "#ff7b00"
            },
            {
                "id": "card-1759150835357-3-layer-3-1759150897929",
                "name": "Sand",
                "height": 99,
                "color": "#fff700"
            }
        ],
        "initialView": {
            "center": {
                "lat": 51.766983379342484,
                "lng": 14.32045876979828
            },
            "zoom": 17
        }
    },
    {
        "id": "card-1759150924074-4",
        "title": "RKS5",
        "coords": {
            "lat": 51.766863865309084,
            "lng": 14.320163677531738
        },
        "nhn": 63.1,
        "layers": [
            {
                "id": "card-1759150924074-4-layer-1-1759150924074",
                "name": "Asphalt",
                "height": 56,
                "color": "#808080"
            },
            {
                "id": "card-1759150924074-4-layer-2-1759150973943",
                "name": "Erde",
                "height": 70,
                "color": "#c69262"
            },
            {
                "id": "card-1759150924074-4-layer-3-1759150995084",
                "name": "Sand",
                "height": 34,
                "color": "#fff700"
            }
        ],
        "initialView": {
            "center": {
                "lat": 51.766983379342484,
                "lng": 14.32045876979828
            },
            "zoom": 17
        }
    },
    {
        "id": "card-1759151019340-5",
        "title": "RKS6",
        "coords": {
            "lat": 51.76738175716856,
            "lng": 14.32007788907888
        },
        "nhn": 63.8,
        "layers": [
            {
                "id": "card-1759151019340-5-layer-1-1759151019340",
                "name": "Erde",
                "height": 45,
                "color": "#c69262"
            },
            {
                "id": "card-1759151019340-5-layer-2-1759151124415",
                "name": "Wasser",
                "height": 23,
                "color": "#0080ff"
            },
            {
                "id": "card-1759151019340-5-layer-3-1759151165445",
                "name": "Kies",
                "height": 140,
                "color": "#ff7b00"
            }
        ],
        "initialView": {
            "center": {
                "lat": 51.766983379342484,
                "lng": 14.32045876979828
            },
            "zoom": 17
        }
    },
    {
        "id": "card-1759151210206-6",
        "title": "RKS7",
        "coords": {
            "lat": 51.76753845152393,
            "lng": 14.320755079859207
        },
        "nhn": 62.9,
        "layers": [
            {
                "id": "card-1759151210206-6-layer-1-1759151210206",
                "name": "Asphalt",
                "height": 15,
                "color": "#808080"
            },
            {
                "id": "card-1759151210206-6-layer-2-1759151254828",
                "name": "Erde",
                "height": 65,
                "color": "#c69262"
            },
            {
                "id": "card-1759151210206-6-layer-3-1759151272794",
                "name": "Sand",
                "height": 41,
                "color": "#fff700"
            }
        ],
        "initialView": {
            "center": {
                "lat": 51.766983379342484,
                "lng": 14.32045876979828
            },
            "zoom": 17
        }
    }
];

// reference point = centroid -> equirectangular approximation
const refLat = boreholes.reduce((s,b)=>s+b.coords.lat,0)/boreholes.length;
const refLon = boreholes.reduce((s,b)=>s+b.coords.lng,0)/boreholes.length;
const metersPerDegLat = 111320;
const metersPerDegLon = 111320 * Math.cos(refLat * Math.PI/180);

function latLonToXZ(lat, lon) {
  const x = (lon - refLon) * metersPerDegLon;
  const z = (lat - refLat) * metersPerDegLat;
  return { x, z };
}

// Ground grid (XZ plane) -- Three.js uses Y up
const nhnValues = boreholes.map(bh => bh.nhn);
const minNHN = Math.min(...nhnValues);
const maxNHN = Math.max(...nhnValues);
const midNHN = (minNHN + maxNHN) / 2;

// 1. X/Z-Positionen der Bohrkerne berechnen
const positions = boreholes.map(bh => latLonToXZ(bh.coords.lat, bh.coords.lng));

// 2. Min/Max für X und Z finden
const xs = positions.map(p => p.x);
const zs = positions.map(p => p.z);
const minX = Math.min(...xs);
const maxX = Math.max(...xs);
const minZ = Math.min(...zs);
const maxZ = Math.max(...zs);
const centerX = (minX + maxX) / 2;
const centerZ = (minZ + maxZ) / 2;

// 3. Grid-Größe bestimmen (größte Ausdehnung + Puffer)
const extentX = maxX - minX;
const extentZ = maxZ - minZ;
const gridSize = Math.max(extentX, extentZ) * 1.5; // 10% Puffer

// 4. Divisionen bestimmen (z.B. alle 20 Meter eine Linie, mindestens 10)
const divisions = Math.max(10, Math.round(gridSize / 20));

// 5. Grid erzeugen und mittig platzieren
const colorCenterLine = 0xdfdfdf;
const colorGrid = 0xdfdfdf;
const gridHelper = new THREE.GridHelper(gridSize, divisions, colorCenterLine, colorGrid);
gridHelper.position.y = midNHN;
scene.add(gridHelper);

// Kamera automatisch zentrieren und skalieren
const maxExtent = Math.max(maxX - minX, maxZ - minZ);
const distance = maxExtent * 1.5; // etwas Abstand

camera.position.set(centerX + distance, midNHN + distance, centerZ + distance);
camera.lookAt(centerX, midNHN, centerZ);

// create stacked cylinders along Y (up) -- top is at Y=0 (ground)
function createBoreholeGroup(x, z, layers, radius=2.8) {
  const g = new THREE.Group();
  let currentDepth = 0;
  layers.forEach((layer, idx) => {
    const h = layer.height / 100; // <-- Umrechnung von cm in m
    const geom = new THREE.CylinderGeometry(radius, radius, h, 32);
    const mat = new THREE.MeshStandardMaterial({color: layer.color, roughness:0.8, metalness:0.1});
    const mesh = new THREE.Mesh(geom, mat);
    // Cylinder's height is along Y; place center at Y = - (currentDepth + h/2)
    mesh.position.set(x, -(currentDepth + h/2), z);
    mesh.userData = { layerIndex: idx, thickness: h, borehole: null };
    g.add(mesh);
    currentDepth += h;
  });
  /*
  // small marker at top
  const topMat = new THREE.MeshBasicMaterial({color:0x000000});
  const topSphere = new THREE.Mesh(new THREE.SphereGeometry(0.12,8,8), topMat);
  topSphere.position.set(x, 0.15, z);
  g.add(topSphere);*/
  return g;
}

// add boreholes to scene
boreholes.forEach(bh=>{
  const p = latLonToXZ(bh.coords.lat, bh.coords.lng); // <-- geändert
  const grp = createBoreholeGroup(p.x, p.z, bh.layers);
  grp.name = bh.id;
  grp.position.y = bh.nhn;
  scene.add(grp);
});
/*
// Axes helper (small)
const axes = new THREE.AxesHelper(5);
scene.add(axes);
*/
// Orbit controls
const controls = new OrbitControls(camera, renderer.domElement);
controls.target.set(0, midNHN, 0);
controls.update();

window.addEventListener('resize', onWindowResize,false);
function onWindowResize(){
  camera.aspect = window.innerWidth/window.innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(window.innerWidth, window.innerHeight);
}
/*
// clicking a layer shows its thickness
const raycaster = new THREE.Raycaster();
const mouse = new THREE.Vector2();
window.addEventListener('pointerdown', (ev)=>{
  mouse.x = (ev.clientX / window.innerWidth) * 2 - 1;
  mouse.y = - (ev.clientY / window.innerHeight) * 2 + 1;
  raycaster.setFromCamera(mouse, camera);
  // intersect all meshes
  const intersects = raycaster.intersectObjects(scene.children, true);
  if(intersects.length){
    const hit = intersects[0].object;
    if(hit.userData && hit.userData.thickness){
      const bh = hit.parent ? hit.parent.name || '' : '';
      alert(`${bh} — Schicht ${hit.userData.layerIndex+1}: Mächtigkeit ${hit.userData.thickness} m`);
    }
  }
});
*/
function animate(){
  requestAnimationFrame(animate);
  renderer.render(scene, camera);
}
animate();

</script>
</body>
</html>
